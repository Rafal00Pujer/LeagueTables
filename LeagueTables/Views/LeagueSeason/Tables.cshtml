@model LeagueTables.Models.LeagueSeason.LeagueSeasonTablesModel

@{
    ViewData["Title"] = $"{Model.LeagueName} {Model.Name}";
}

<div class="row">
    <div class="col-12">
        <h1 class="text-center">@ViewData["Title"]</h1>
    </div>

    @if (Model.Description is not null)
    {
        <div class="col-12 mt-3">
            <p>@Model.Description</p>
        </div>
    }
</div>

@if (Model.Tables.Count == 0)
{
    <div class="mt-3">
        <p class="text-center">There is no tables for this season.</p>
    </div>
}
else
{
    <div class="row mt-3">
        <nav>
            <div class="nav nav-pills justify-content-center" id="tables-tab" role="tablist">
                @foreach (var (index, table) in Enumerable.Range(0, Model.Tables.Count).Zip(Model.Tables))
                {
                    <button id="tables-@index-tab" class="nav-link @(index == 0 ? "active" : "")"
                            data-bs-toggle="pill" data-bs-target="#tables-@index" type="button" role="tab"
                            aria-controls="tables-@index" aria-selected="@(index == 0 ? "true" : "false")">
                        @table.Name
                    </button>
                }

                <a class="nav-link" asp-action="TeamsInSeason" asp-controller="Team" asp-route-seasonId="@Model.Id">Teams</a>

            </div>
        </nav>
    </div>

    <div class="tab-content mt-3" id="tables-tabContent">
        @foreach (var (tableIndex, table) in Enumerable.Range(0, Model.Tables.Count).Zip(Model.Tables))
        {
            <div id="tables-@tableIndex" class="tab-pane fade @(tableIndex == 0 ? "active show" : "")"
                 role="tabpanel" aria-labelledby="tables-@tableIndex-tab" tabindex="@tableIndex">

                <div>
                    <a class="btn btn-primary" asp-action="Rounds" asp-controller="Table" asp-route-tableId="@table.Id">Table Rounds</a>
                </div>

                @if (table.TableScores.Count > 0)
                {
                    <table class="table table-striped table-hover mt-2">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Team Name</th>

                                <th scope="col">MP</th>
                                <th scope="col">W</th>
                                <th scope="col">D</th>
                                <th scope="col">L</th>

                                <th scope="col">GF</th>
                                <th scope="col">GA</th>
                                <th scope="col">GD</th>

                                <th scope="col">PTS</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var (scoreIndex, score) in Enumerable.Range(1, table.TableScores.Count + 1).Zip(table.TableScores.OrderByDescending(x => x.Points)))
                            {
                                <tr>
                                    <th scope="row">@scoreIndex</th>
                                    <th class="teamColumn"
                                        onclick="GetMatchesForTeamInTable(
                                        '@Url.Action("MatchesForTeamInTable", "Match", new {tableId = table.Id, teamId = score.TeamId})',
                                        '@score.TeamName','#matchesForTeamInTable-@tableIndex')">

                                        @score.TeamName
                                    </th>

                                    <th>@score.MatchesPlayed</th>
                                    <th>@score.Wins</th>
                                    <th>@score.Draws</th>
                                    <th>@score.Losses</th>

                                    <th>@score.GoalsFor</th>
                                    <th>@score.GoalsAgainst</th>
                                    <th>@score.GoalsDifference</th>

                                    <th>@score.Points</th>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div id="matchesForTeamInTable-@tableIndex"></div>
                }
                else
                {
                    <div>
                        <p class="text-center">There is no scores for this table.</p>
                    </div>
                }
            </div>
        }
    </div>
}

@section Scripts
{
    <script>
        function GetMatchesForTeamInTable(url, teamName, targetDivName) {

            var targetDiv = $(targetDivName);

            // targetDiv.empty();
            // targetDiv.html('<p class="text-center">Loading matches with ' + teamName + '...</p>');

            $.ajax({
                type: "GET",
                url: url,
                success: function (result) {
                    targetDiv.empty();

                    var header = '<h3 class="text-center">Matches with ' + teamName + '</h3>';

                    targetDiv.html(header + result);

                    $('html, body').animate({
                        scrollTop: targetDiv.offset().top
                    }, 100);
                },
                error: function (req, status, error) {
                    targetDiv.empty();
                    targetDiv.html('<p class="text-center text-danger">Unable to load matches for' + teamName + '.</p>');
                }
            })
        }
    </script>
}

@section Style
{
    <link rel="stylesheet" href="~/css/LeagueSeason/Tables.css" />
}